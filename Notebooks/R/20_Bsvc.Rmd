---
editor_options: 
  markdown: 
    wrap: 72
---

**CURSO**: AnÃ¡lisis Geoespacial, Departamento de Geociencias y Medio
Ambiente, Universidad Nacional de Colombia - sede MedellÃ­n\
**Profesor**: Edier AristizÃ¡bal
([evaristizabalg\@unal.edu.co](mailto:evaristizabalg@unal.edu.co){.email})\
**Credits**: The content of this notebook is based on
[datascience+](https://datascienceplus.com/spatial-regression-in-r-part-2-inla/)
by Lionel Hertzog, and [Spatial Statistics for Data Science: Theory and
Practice with
R](https://www.paulamoraga.com/book-spatial/sec-geostatisticaldataSPDE.html)

## Bayesian Spatial Varying Coefficient models (Bsvc)

En un modelo Bayesian Spatially Varying Coefficient (SVC), la prior
covariance matrix define cÃ³mo se modela la variabilidad y correlaciÃ³n
espacial de los coeficientes en el modelo. La distinciÃ³n entre una forma
separable y no separable se refiere a cÃ³mo se estructura la covarianza
entre las ubicaciones espaciales y las diferentes variables explicativas
en el modelo.

### Forma Separable

En un modelo con covarianza separable, se asume que la matriz de
covarianza espacial se puede descomponer en dos componentes
independientes:

Î£=Î£ğ‘ âŠ—Î£ğ‘

donde:

Î£ğ‘ es la matriz de covarianza espacial, que captura la dependencia entre
las ubicaciones geogrÃ¡ficas. Î£ğ‘es la matriz de covarianza entre los
coeficientes de las variables explicativas. Esto implica que la
dependencia espacial y la correlaciÃ³n entre coeficientes se modelan de
manera independiente, lo que simplifica los cÃ¡lculos y permite una mayor
flexibilidad en la especificaciÃ³n de cada componente.

### Forma No Separable

En una covarianza no separable, la matriz de covarianza es completamente
general y no se puede descomponer en dos partes independientes:

Î£=ğ‘“(ğ‘ ,ğ‘) donde la dependencia espacial y la correlaciÃ³n entre
coeficientes estÃ¡n intrÃ­nsecamente ligadas en una estructura mÃ¡s
compleja. Esto significa que la relaciÃ³n espacial entre los coeficientes
puede depender de la interacciÃ³n entre las variables explicativas y la
geografÃ­a.

Si se asume que la estructura espacial y la correlaciÃ³n entre
coeficientes son independientes, la forma separable es una buena opciÃ³n.
Si se sospecha que la interacciÃ³n entre espacio y coeficientes es
fuerte, una forma no separable puede ser mÃ¡s adecuada, aunque con mayor
costo computacional.

Un modelo SVC modela los coeficientes ğ›½ğ‘˜(ğ‘ ) como funciones del espacio:

ğ‘¦(ğ‘ )=ğ‘‹(ğ‘ )ğ›½(ğ‘ )+ğœ–(ğ‘ ) donde:

ğ‘¦(ğ‘ ) es la variable respuesta en la ubicaciÃ³n . ğ‘‹(ğ‘ ) es la matriz de
covariables en s. ğ›½(ğ‘ )=(ğ›½1(ğ‘ ),â€¦,ğ›½ğ¾(ğ‘ ))âŠ¤â€‹ (s))âŠ¤ son los coeficientes
espacialmente variables. ğœ–(ğ‘ )âˆ¼ğ‘(0,ğœ2) es el error aleatorio. Los
coeficientes espaciales se modelan como un proceso gaussiano
multivariado (MGP):

ğ›½(ğ‘ )âˆ¼ğºğ‘ƒ(ğœ‡,Î£(ğ‘ ,ğ‘ â€²)) donde la matriz de covarianza Î£(s,ğ‘ â€²) captura tanto
la correlaciÃ³n espacial como la interdependencia entre los coeficientes.

### ImplementaciÃ³n de la Covarianza No Separable

En la forma no separable, la matriz de covarianza Î£(ğ‘ ,ğ‘ â€²) se construye
como una matriz general de covarianza bloqueada que captura
simultÃ¡neamente la estructura espacial y la correlaciÃ³n entre
coeficientes:

Cada submatriz Î£ğ›½ğ‘–,ğ›½ğ‘—(ğ‘ ,ğ‘ â€²) representa la covarianza entre los
coeficientes ğ›½ğ‘–ğ›½ğ‘—en dos ubicaciones espaciales ğ‘  y ğ‘ â€². Para definir
estas submatrices, podemos usar un proceso gaussiano multivariado con un
kernel espacial de la forma:

Î£ğ›½ğ‘–,ğ›½ğ‘—(ğ‘ ,ğ‘ â€²)=ğœŒğ‘–ğ‘—ğ¾spatial(ğ‘ ,ğ‘ â€²;ğœƒğ‘ ) ) donde:

ğœŒğ‘–ğ‘—es el parÃ¡metro de correlaciÃ³n entre los coeficientes
ğ›½ğ‘–yğ›½ğ‘—.ğ¾spatial(ğ‘ ,ğ‘ â€²;ğœƒğ‘ ) es una funciÃ³n de covarianza espacial (kernel)
con parÃ¡metros espaciales ğœƒğ‘ , como el kernel exponencial cuadrÃ¡tico
(MatÃ©rn 3/2, 5/2, etc.)

```{r}

#ImplementaciÃ³n en INLA (SVC Separable)

library(INLA)
library(sp)
library(rgdal)
library(fields)
library(ggplot2)

# 1. Datos simulados
n <- 100
set.seed(123)
coords <- cbind(runif(n, 0, 10), runif(n, 0, 10))
X1 <- rnorm(n)
X2 <- rnorm(n)
y <- 3 + 2 * X1 + 1.5 * X2 + rnorm(n)

# 2. ConstrucciÃ³n de la malla para el SPDE
mesh <- inla.mesh.2d(loc = coords, max.edge = c(1, 2), cutoff = 0.1)

# 3. Modelo SPDE para capturar dependencia espacial
spde <- inla.spde2.matern(mesh = mesh, alpha = 2)

# 4. Ãndices para los efectos aleatorios espaciales
idx <- inla.spde.make.index("spatial.field", n.spde = spde$n.spde, n.group = 2)

# 5. Matriz de predictores y el stack
A <- inla.spde.make.A(mesh = mesh, loc = coords, group = rep(1:2, each = n))

stack <- inla.stack(
  data = list(y = y),
  A = list(A, 1),
  effects = list(
    list(idx = idx),
    data.frame(intercept = 1, X1 = X1, X2 = X2)
  ),
  tag = "estimation"
)

# 6. Modelo con estructura separable
formula <- y ~ -1 + intercept + X1 + X2 +
  f(spatial.field, model = spde, group = spatial.field.group, control.group = list(model = "exchangeable"))

# 7. Ajustar el modelo
result <- inla(
  formula, data = inla.stack.data(stack),
  family = "gaussian",
  control.predictor = list(A = inla.stack.A(stack), compute = TRUE),
  control.compute = list(dic = TRUE, waic = TRUE, cpo = TRUE)
)

summary(result)

```


```{r}
# 1. Definir la matriz de correlaciÃ³n entre coeficientes
rho_prior <- list(initial = log(0.5 / (1 - 0.5)), fixed = FALSE)

# 2. Modelo con estructura no separable
formula_ns <- y ~ -1 + intercept + X1 + X2 +
  f(spatial.field, model = spde, group = spatial.field.group,
    control.group = list(model = "iid", hyper = rho_prior))

# 3. Ajustar el modelo
result_ns <- inla(
  formula_ns, data = inla.stack.data(stack),
  family = "gaussian",
  control.predictor = list(A = inla.stack.A(stack), compute = TRUE),
  control.compute = list(dic = TRUE, waic = TRUE, cpo = TRUE)
)

summary(result_ns)
```

## Gaussian Process Splines dentro de modelos GAM (Generalized Additive Models)
```{r}
library(mgcv)
library(ggplot2)
library(dplyr)
library(gratia)  # Para visualizar resultados GAM

# Generar datos simulados
set.seed(123)
n <- 100
coords <- data.frame(x = runif(n, 0, 10), y = runif(n, 0, 10))
X1 <- rnorm(n)
X2 <- rnorm(n)
y <- 3 + 2 * X1 + 1.5 * X2 + sin(coords$x) + rnorm(n, sd=0.5)

# Unir los datos en un dataframe
data <- data.frame(y, X1, X2, x = coords$x, y = coords$y)

# Modelo GAM con splines espaciales para modelar el efecto espacial
gam_separable <- gam(y ~ X1 + X2 + s(x, y, bs="tp") + s(X1, x, y, bs="tp") + s(X2, x, y, bs="tp"),
                     data = data, method = "REML")

# Resumen del modelo
summary(gam_separable)

# Visualizar los efectos espaciales
draw(gam_separable)
```

s(x, y, bs="tp") modela un efecto espacial global con splines de base delgada (tp = thin plate splines).
s(X1, x, y, bs="tp") y s(X2, x, y, bs="tp") permiten que los coeficientes de regresiÃ³n de X1 y X2 varÃ­en espacialmente.
method="REML" usa mÃ¡xima verosimilitud restringida para evitar sobreajuste.

Este modelo es eficiente, pero asume que la correlaciÃ³n espacial es independiente de la correlaciÃ³n entre los coeficientes.

```{r}
# Modelo GAM con interacciÃ³n espacial no separable
gam_nonseparable <- gam(y ~ s(x, y, bs="tp") + te(X1, x, y, bs=c("tp", "tp")) + te(X2, x, y, bs=c("tp", "tp")),
                        data = data, method = "REML")

# Resumen del modelo
summary(gam_nonseparable)

# Visualizar los efectos espaciales
draw(gam_nonseparable)
```

s(x, y, bs="tp") modela un efecto espacial base.
te(X1, x, y, bs=c("tp", "tp")) usa un tensor de producto que permite que X1 y la localizaciÃ³n interactÃºen no separablemente.
te(X2, x, y, bs=c("tp", "tp")) hace lo mismo con ğ‘‹2.
Este modelo permite que la variabilidad espacial de los coeficientes estÃ© correlacionada con la ubicaciÃ³n, lo que lo hace mÃ¡s flexible.
 
```{r}
 AIC(gam_separable, gam_nonseparable)

cat("Deviance explained (Separable):", summary(gam_separable)$dev.expl, "\n")
cat("Deviance explained (Non-separable):", summary(gam_nonseparable)$dev.expl, "\n")

# PredicciÃ³n en una malla espacial
grid <- expand.grid(x = seq(0, 10, length=50), y = seq(0, 10, length=50))
grid$X1 <- 0
grid$X2 <- 0

# Predicciones del modelo no separable
grid$pred_nonseparable <- predict(gam_nonseparable, newdata = grid, type="response")

ggplot(grid, aes(x, y, fill=pred_nonseparable)) +
  geom_tile() +
  scale_fill_viridis_c() +
  theme_minimal() +
  ggtitle("Efecto Espacial del Modelo No Separable")

```
